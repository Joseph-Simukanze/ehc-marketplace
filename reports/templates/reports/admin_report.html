{% extends 'base.html' %} {% load static %} {% block title %}Admin Report - EHC Marketplace{% endblock %} {% block content %}
<div class="container py-5">
    <!-- Header -->
    <div class="d-flex justify-content-between align-items-center mb-5">
        <h1 class="fs-2 fw-bold text-primary" role="heading" aria-level="1">Admin Dashboard</h1>
        <div>
            <a href="{% url 'admin:index' %}" class="btn btn-outline-primary btn-hover" aria-label="Go to Admin Panel">
                <i class="fas fa-cog me-2"></i> Admin Panel
            </a>
        </div>
    </div>

    <!-- Date Range Filter -->
    <div class="card shadow-sm mb-5 border-0 rounded-3">
        <div class="card-header bg-gradient-primary text-white">
            <h5 class="mb-0">Filter by Date Range</h5>
        </div>
        <div class="card-body">
            <form id="date-filter-form" method="get" class="row g-3 align-items-center" onsubmit="return validateDateForm()">
                <div class="col-md-4">
                    <label for="start-date" class="form-label fw-medium">Start Date</label>
                    <input type="date" id="start-date" name="start_date" class="form-control" value="{{ request.GET.start_date|default_if_none:'' }}" required aria-describedby="start-date-error">
                    <div id="start-date-error" class="invalid-feedback"></div>
                </div>
                <div class="col-md-4">
                    <label for="end-date" class="form-label fw-medium">End Date</label>
                    <input type="date" id="end-date" name="end_date" class="form-control" value="{{ request.GET.end_date|default_if_none:'' }}" required aria-describedby="end-date-error">
                    <div id="end-date-error" class="invalid-feedback"></div>
                </div>
                <div class="col-md-4 d-flex align-items-end">
                    <button type="submit" class="btn btn-primary btn-hover w-100">Apply Filter</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Overview Cards -->
    <div class="row g-4 mb-5">
        <div class="col-12 col-md-6 col-lg-3">
            <div class="card shadow-sm text-center admin-card border-0 rounded-3">
                <div class="card-body">
                    <div class="bg-primary bg-opacity-10 rounded-circle d-inline-flex align-items-center justify-content-center mb-3" style="width: 80px; height: 80px;">
                        <i class="fas fa-users fa-3x text-primary"></i>
                    </div>
                    <h5 class="card-title fw-semibold">Total Users</h5>
                    <p class="h3 text-primary" aria-label="Total users: {{ total_users }}">{{ total_users }}</p>
                    <p class="text-muted small" aria-label="Total sellers: {{ total_sellers }}">{{ total_sellers }} Sellers</p>
                </div>
            </div>
        </div>
        <div class="col-12 col-md-6 col-lg-3">
            <div class="card shadow-sm text-center admin-card border-0 rounded-3">
                <div class="card-body">
                    <div class="bg-primary bg-opacity-10 rounded-circle d-inline-flex align-items-center justify-content-center mb-3" style="width: 80px; height: 80px;">
                        <i class="fas fa-box-open fa-3x text-primary"></i>
                    </div>
                    <h5 class="card-title fw-semibold">Total Products</h5>
                    <p class="h3 text-primary" aria-label="Total products: {{ total_products }}">{{ total_products }}</p>
                </div>
            </div>
        </div>
        <div class="col-12 col-md-6 col-lg-3">
            <div class="card shadow-sm text-center admin-card border-0 rounded-3">
                <div class="card-body">
                    <div class="bg-primary bg-opacity-10 rounded-circle d-inline-flex align-items-center justify-content-center mb-3" style="width: 80px; height: 80px;">
                        <i class="fas fa-shopping-cart fa-3x text-primary"></i>
                    </div>
                    <h5 class="card-title fw-semibold">Total Orders</h5>
                    <p class="h3 text-primary" aria-label="Total orders: {{ total_orders }}">{{ total_orders }}</p>
                </div>
            </div>
        </div>
        <div class="col-12 col-md-6 col-lg-3">
            <div class="card shadow-sm text-center admin-card border-0 rounded-3">
                <div class="card-body">
                    <div class="bg-primary bg-opacity-10 rounded-circle d-inline-flex align-items-center justify-content-center mb-3" style="width: 80px; height: 80px;">
                        <i class="fas fa-money-bill-wave fa-3x text-primary"></i>
                    </div>
                    <h5 class="card-title fw-semibold">Total Revenue</h5>
                    <p class="h3 text-primary" aria-label="Total revenue: ZMW {{ total_revenue|floatformat:2 }}">ZMW {{ total_revenue|floatformat:2 }}</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Products Sold by Users -->
    <div class="card shadow-sm mb-5 border-0 rounded-3">
        <div class="card-header bg-gradient-primary text-white d-flex justify-content-between align-items-center">
            <h5 class="mb-0">Products Sold by Users</h5>
            <a href="{% url 'reports:export_products_sold_csv' %}" class="btn btn-sm btn-light btn-hover" aria-label="Export Products Sold as CSV">
                <i class="fas fa-file-csv me-2"></i> Export CSV
            </a>
        </div>
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-hover mb-0" id="products-sold-table">
                    <thead class="table-light">
                        <tr>
                            <th scope="col" data-sort="seller">Seller <i class="fas fa-sort"></i></th>
                            <th scope="col" data-sort="product">Product <i class="fas fa-sort"></i></th>
                            <th scope="col" data-sort="category">Category <i class="fas fa-sort"></i></th>
                            <th scope="col" data-sort="quantity">Quantity Sold <i class="fas fa-sort"></i></th>
                            <th scope="col" data-sort="revenue">Revenue (ZMW) <i class="fas fa-sort"></i></th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for sale in products_sold_data %}
                        <tr>
                            <td>{{ sale.product__seller__username }}</td>
                            <td>{{ sale.product__title }}</td>
                            <td>{{ sale.product__category__name|default:'N/A' }}</td>
                            <td>{{ sale.quantity_sold }}</td>
                            <td>ZMW {{ sale.revenue|floatformat:2 }}</td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="5" class="text-center py-3">No products sold in the selected period</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Registered Users -->
    <div class="card shadow-sm mb-5 border-0 rounded-3">
        <div class="card-header bg-gradient-primary text-white d-flex justify-content-between align-items-center">
            <h5 class="mb-0">Registered Users</h5>
            <a href="{% url 'reports:export_users_csv' %}" class="btn btn-sm btn-light btn-hover" aria-label="Export Users as CSV">
                <i class="fas fa-file-csv me-2"></i> Export CSV
            </a>
        </div>
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-hover mb-0" id="users-table">
                    <thead class="table-light">
                        <tr>
                            <th scope="col" data-sort="username">Username <i class="fas fa-sort"></i></th>
                            <th scope="col" data-sort="email">Email <i class="fas fa-sort"></i></th>
                            <th scope="col" data-sort="role">Role <i class="fas fa-sort"></i></th>
                            <th scope="col" data-sort="date_joined">Date Joined <i class="fas fa-sort"></i></th>
                            <th scope="col" data-sort="status">Status <i class="fas fa-sort"></i></th>
                            <th scope="col">Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for user in registered_users %}
                        <tr>
                            <td>{{ user.username }}</td>
                            <td>{{ user.email|default:'N/A' }}</td>
                            <td>{{ user.role|default:'Buyer' }}</td>
                            <td>{{ user.date_joined|date:"M d, Y" }}</td>
                            <td>
                                <span class="badge {% if user.is_active %}bg-success{% else %}bg-danger{% endif %}">
                                    {{ user.is_active|yesno:"Active,Inactive" }}
                                </span>
                            </td>
                            <td>
                                <button class="btn btn-sm btn-outline-primary me-1 toggle-user" data-user-id="{{ user.id }}" data-active="{{ user.is_active|yesno:'true,false' }}" aria-label="{% if user.is_active %}Deactivate{% else %}Activate{% endif %} {{ user.username }}">
                                    <i class="fas {% if user.is_active %}fa-user-slash{% else %}fa-user-check{% endif %}"></i>
                                </button>
                                <div class="dropdown d-inline-block">
                                    <button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Change role for {{ user.username }}">
                                        <i class="fas fa-user-tag"></i>
                                    </button>
                                    <ul class="dropdown-menu">
                                        <li><a class="dropdown-item change-role" href="#" data-user-id="{{ user.id }}" data-role="buyer">Buyer</a></li>
                                        <li><a class="dropdown-item change-role" href="#" data-user-id="{{ user.id }}" data-role="seller">Seller</a></li>
                                        <li><a class="dropdown-item change-role" href="#" data-user-id="{{ user.id }}" data-role="admin">Admin</a></li>
                                    </ul>
                                </div>
                                <button class="btn btn-sm btn-outline-danger ms-1 delete-user" data-user-id="{{ user.id }}" data-bs-toggle="modal" data-bs-target="#deleteUserModal" aria-label="Delete {{ user.username }}">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="6" class="text-center py-3">No users found</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Delete User Confirmation Modal -->
    <div class="modal fade" id="deleteUserModal" tabindex="-1" aria-labelledby="deleteUserModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content rounded-3">
                <div class="modal-header">
                    <h5 class="modal-title" id="deleteUserModalLabel">Confirm User Deletion</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    Are you sure you want to delete this user? This action cannot be undone.
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-danger" id="confirm-delete-user">Delete</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Revenue Chart -->
    <div class="card shadow-sm mb-5 border-0 rounded-3">
        <div class="card-header bg-gradient-primary text-white">
            <h5 class="mb-0">Revenue Overview</h5>
        </div>
        <div class="card-body">
            <canvas id="revenue-chart" style="height: 300px;"></canvas>
        </div>
    </div>

    <!-- User Registration and Product Categories -->
    <div class="row g-4 mb-5">
        <div class="col-12 col-md-6">
            <div class="card shadow-sm h-100 border-0 rounded-3">
                <div class="card-header bg-gradient-primary text-white">
                    <h5 class="mb-0">User Registration</h5>
                </div>
                <div class="card-body">
                    <canvas id="registration-chart" style="height: 300px;"></canvas>
                    <h6 class="mt-4 fw-semibold">Recent Registered Users</h6>
                    <table class="table table-sm table-bordered">
                        <thead>
                            <tr>
                                <th>Username</th>
                                <th>Date Joined</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for user in recent_registered_users %}
                            <tr>
                                <td>{{ user.username }}</td>
                                <td>{{ user.date_joined|date:"Y-m-d H:i" }}</td>
                            </tr>
                            {% empty %}
                            <tr>
                                <td colspan="2" class="text-center">No registered users found.</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        <div class="col-12 col-md-6">
            <div class="card shadow-sm h-100 border-0 rounded-3">
                <div class="card-header bg-gradient-primary text-white">
                    <h5 class="mb-0">Product Categories</h5>
                </div>
                <div class="card-body">
                    <canvas id="category-chart" style="height: 300px;"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- Recent Orders -->
    <div class="card shadow-sm mb-5 border-0 rounded-3">
        <div class="card-header bg-gradient-primary text-white d-flex justify-content-between align-items-center">
            <h5 class="mb-0">Recent Orders</h5>
            <div>
                <a href="{% url 'reports:export_sales_report_pdf' %}" class="btn btn-sm btn-light btn-hover me-2" aria-label="Export Orders as PDF">
                    <i class="fas fa-file-pdf me-2"></i> Export PDF
                </a>
                <a href="{% url 'reports:export_sales_report_csv' %}" class="btn btn-sm btn-light btn-hover me-2" aria-label="Export Orders as CSV">
                    <i class="fas fa-file-csv me-2"></i> Export CSV
                </a>
                <a href="{% url 'reports:change_list' %}" class="btn btn-sm btn-light btn-hover" aria-label="View All Orders">View All</a>
            </div>
        </div>
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-hover mb-0" id="orders-table">
                    <thead class="table-light">
                        <tr>
                            <th scope="col" data-sort="id">Order ID <i class="fas fa-sort"></i></th>
                            <th scope="col" data-sort="customer">Customer <i class="fas fa-sort"></i></th>
                            <th scope="col" data-sort="items">Items <i class="fas fa-sort"></i></th>
                            <th scope="col" data-sort="total">Total <i class="fas fa-sort"></i></th>
                            <th scope="col" data-sort="status">Status <i class="fas fa-sort"></i></th>
                            <th scope="col" data-sort="date">Date <i class="fas fa-sort"></i></th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for order in recent_orders %}
                        <tr>
                            <td>{{ order.id }}</td>
                            <td>{{ order.buyer.get_full_name|default:order.buyer.username }}</td>
                            <td>{{ order.items.count }}</td>
                            <td>ZMW {{ order.total_amount|floatformat:2 }}</td>
                            <td>
                                <span class="badge 
                                    {% if order.status == 'completed' %}bg-success
                                    {% elif order.status == 'processing' %}bg-warning
                                    {% else %}bg-info{% endif %}">
                                    {{ order.status|title }}
                                </span>
                            </td>
                            <td>{{ order.order_date|date:"M d, Y" }}</td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="6" class="text-center py-3">No orders found</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Subscription Revenue -->
    <div class="card shadow-sm mb-5 border-0 rounded-3">
        <div class="card-header bg-gradient-primary text-white">
            <h5 class="mb-0">Subscription Revenue</h5>
        </div>
        <div class="card-body">
            <div class="row g-4 mb-4">
                <div class="col-12 col-md-4 text-center">
                    <div class="bg-primary bg-opacity-10 rounded-circle d-inline-flex align-items-center justify-content-center mb-3" style="width: 80px; height: 80px;">
                        <i class="fas fa-crown fa-3x text-warning"></i>
                    </div>
                    <h5 class="card-title fw-semibold">Active Subscriptions</h5>
                    <p class="h3 text-primary" aria-label="Active subscriptions: {{ active_subscriptions }}">{{ active_subscriptions }}</p>
                </div>
                <div class="col-12 col-md-4 text-center">
                    <div class="bg-primary bg-opacity-10 rounded-circle d-inline-flex align-items-center justify-content-center mb-3" style="width: 80px; height: 80px;">
                        <i class="fas fa-money-bill-wave fa-3x text-success"></i>
                    </div>
                    <h5 class="card-title fw-semibold">Monthly Revenue</h5>
                    <p class="h3 text-primary" aria-label="Monthly revenue: ZMW {{ monthly_subscription_revenue|floatformat:2 }}">ZMW {{ monthly_subscription_revenue|floatformat:2 }}</p>
                </div>
                <div class="col-12 col-md-4 text-center">
                    <div class="bg-primary bg-opacity-10 rounded-circle d-inline-flex align-items-center justify-content-center mb-3" style="width: 80px; height: 80px;">
                        <i class="fas fa-chart-line fa-3x text-primary"></i>
                    </div>
                    <h5 class="card-title fw-semibold">Total Subscription Revenue</h5>
                    <p class="h3 text-primary" aria-label="Total subscription revenue: ZMW {{ total_subscription_revenue|floatformat:2 }}">ZMW {{ total_subscription_revenue|floatformat:2 }}</p>
                </div>
            </div>
            <canvas id="subscription-chart" style="height: 300px;"></canvas>
            <h6 class="mt-4 fw-semibold">Subscription Details</h6>
            <table class="table table-bordered">
                <thead>
                    <tr>
                        <th>Subscriber</th>
                        <th>Subscription Start Date</th>
                        <th>Amount</th>
                    </tr>
                </thead>
                <tbody>
                    {% for subscription in subscription_data %}
                    <tr>
                        <td>{{ subscription.user.username }}</td>
                        <td>{{ subscription.start_date|date:"Y-m-d" }}</td>
                        <td>ZMW {{ subscription.amount_paid|floatformat:2 }}</td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="3" class="text-center py-3">No subscription data available</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>
{% endblock %} {% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script>
    // Form validation for date range
    function validateDateForm() {
        const startDate = document.getElementById('start-date').value;
        const endDate = document.getElementById('end-date').value;
        const startDateError = document.getElementById('start-date-error');
        const endDateError = document.getElementById('end-date-error');
        let isValid = true;

        startDateError.textContent = '';
        endDateError.textContent = '';

        if (startDate && endDate && new Date(startDate) > new Date(endDate)) {
            endDateError.textContent = 'End date must be after start date';
            isValid = false;
        }

        return isValid;
    }

    // Table sorting function
    function setupTableSorting(tableId) {
        const table = document.getElementById(tableId);
        const headers = table.querySelectorAll('th[data-sort]');
        let sortDirection = 1;
        let currentSortColumn = null;

        headers.forEach(header => {
            header.addEventListener('click', () => {
                const column = header.getAttribute('data-sort');
                if (currentSortColumn === column) {
                    sortDirection *= -1;
                } else {
                    sortDirection = 1;
                    headers.forEach(h => h.querySelector('.fa-sort').classList.remove('fa-sort-up', 'fa-sort-down'));
                }
                currentSortColumn = column;

                const icon = header.querySelector('.fa-sort');
                icon.classList.remove('fa-sort', 'fa-sort-up', 'fa-sort-down');
                icon.classList.add(sortDirection === 1 ? 'fa-sort-up' : 'fa-sort-down');

                sortTable(table, column, sortDirection);
            });
        });

        function sortTable(table, column, direction) {
            const tbody = table.querySelector('tbody');
            const rows = Array.from(tbody.querySelectorAll('tr'));

            rows.sort((a, b) => {
                let aValue = a.querySelector(`td:nth-child(${getColumnIndex(tableId, column)})`).textContent.trim();
                let bValue = b.querySelector(`td:nth-child(${getColumnIndex(tableId, column)})`).textContent.trim();

                if (column === 'revenue' || column === 'total') {
                    aValue = parseFloat(aValue.replace('ZMW ', '')) || 0;
                    bValue = parseFloat(bValue.replace('ZMW ', '')) || 0;
                } else if (column === 'quantity' || column === 'items') {
                    aValue = parseInt(aValue) || 0;
                    bValue = parseInt(bValue) || 0;
                } else if (column === 'date' || column === 'date_joined') {
                    aValue = new Date(aValue);
                    bValue = new Date(bValue);
                } else if (column === 'status') {
                    aValue = aValue.toLowerCase();
                    bValue = bValue.toLowerCase();
                }

                return (aValue < bValue ? -1 : aValue > bValue ? 1 : 0) * direction;
            });

            tbody.innerHTML = '';
            rows.forEach(row => tbody.appendChild(row));
        }

        function getColumnIndex(tableId, column) {
            const columns = {
                'orders-table': ['id', 'customer', 'items', 'total', 'status', 'date'],
                'products-sold-table': ['seller', 'product', 'category', 'quantity', 'revenue'],
                'users-table': ['username', 'email', 'role', 'date_joined', 'status']
            };
            return columns[tableId].indexOf(column) + 1;
        }
    }

    document.addEventListener('DOMContentLoaded', () => {
        // Initialize table sorting for all tables
        setupTableSorting('orders-table');
        setupTableSorting('products-sold-table');
        setupTableSorting('users-table');

        // Revenue Chart
        const ctxRevenue = document.getElementById('revenue-chart').getContext('2d');
        const revenueLabels = [];
        const revenueData = [];
        const orderData = [];

        { %
            for date, data in revenue_data.items %
        }
        revenueLabels.push('{{ date }}');
        revenueData.push({
            {
                data.revenue | floatformat: 2
            }
        });
        orderData.push({
            {
                data.orders
            }
        }); { % endfor %
        }

        new Chart(ctxRevenue, {
            type: 'line',
            data: {
                labels: revenueLabels,
                datasets: [{
                    label: 'Revenue (ZMW)',
                    data: revenueData,
                    backgroundColor: 'rgba(54, 162, 235, 0.2)',
                    borderColor: 'rgba(54, 162, 235, 1)',
                    borderWidth: 2,
                    fill: true,
                    tension: 0.4,
                    yAxisID: 'y'
                }, {
                    label: 'Orders',
                    data: orderData,
                    backgroundColor: 'rgba(255, 99, 132, 0.2)',
                    borderColor: 'rgba(255, 99, 132, 1)',
                    borderWidth: 2,
                    fill: false,
                    tension: 0.4,
                    yAxisID: 'y1'
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    tooltip: {
                        mode: 'index',
                        intersect: false,
                        callbacks: {
                            label: context => `${context.dataset.label}: ${context.dataset.label === 'Revenue (ZMW)' ? 'ZMW ' : ''}${context.raw}`
                        }
                    },
                    legend: {
                        position: 'top',
                        labels: {
                            font: {
                                size: 12
                            }
                        }
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        position: 'left',
                        title: {
                            display: true,
                            text: 'Revenue (ZMW)',
                            font: {
                                size: 14
                            }
                        },
                        grid: {
                            color: 'rgba(0, 0, 0, 0.05)'
                        }
                    },
                    y1: {
                        beginAtZero: true,
                        position: 'right',
                        title: {
                            display: true,
                            text: 'Orders',
                            font: {
                                size: 14
                            }
                        },
                        grid: {
                            drawOnChartArea: false
                        }
                    },
                    x: {
                        title: {
                            display: true,
                            text: 'Date',
                            font: {
                                size: 14
                            }
                        },
                        grid: {
                            color: 'rgba(0, 0, 0, 0.05)'
                        }
                    }
                },
                hover: {
                    mode: 'nearest',
                    intersect: true
                },
                animation: {
                    duration: 1200,
                    easing: 'easeOutQuart'
                }
            }
        });

        // Registration Chart
        const ctxRegistration = document.getElementById('registration-chart').getContext('2d');
        const registrationLabels = [];
        const registrationData = [];

        { %
            for date, count in registration_data.items %
        }
        registrationLabels.push('{{ date }}');
        registrationData.push({
            {
                count
            }
        }); { % endfor %
        }

        new Chart(ctxRegistration, {
            type: 'bar',
            data: {
                labels: registrationLabels,
                datasets: [{
                    label: 'New Users',
                    data: registrationData,
                    backgroundColor: 'rgba(75, 192, 192, 0.5)',
                    borderColor: 'rgba(75, 192, 192, 1)',
                    borderWidth: 1,
                    hoverBackgroundColor: 'rgba(75, 192, 192, 0.7)'
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    tooltip: {
                        callbacks: {
                            label: context => `New Users: ${context.raw}`
                        }
                    },
                    legend: {
                        position: 'top',
                        labels: {
                            font: {
                                size: 12
                            }
                        }
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        title: {
                            display: true,
                            text: 'Users',
                            font: {
                                size: 14
                            }
                        },
                        grid: {
                            color: 'rgba(0, 0, 0, 0.05)'
                        }
                    },
                    x: {
                        title: {
                            display: true,
                            text: 'Date',
                            font: {
                                size: 14
                            }
                        },
                        grid: {
                            color: 'rgba(0, 0, 0, 0.05)'
                        }
                    }
                },
                animation: {
                    duration: 1200,
                    easing: 'easeOutQuart'
                }
            }
        });

        // Category Chart
        const ctxCategory = document.getElementById('category-chart').getContext('2d');
        const categoryLabels = [];
        const categoryData = [];
        const categoryColors = ['rgba(255, 99, 132, 0.7)', 'rgba(54, 162, 235, 0.7)', 'rgba(255, 206, 86, 0.7)', 'rgba(75, 192, 192, 0.7)', 'rgba(153, 102, 255, 0.7)', 'rgba(255, 159, 64, 0.7)'];

        { %
            for category, count in category_data.items %
        }
        categoryLabels.push('{{ category }}');
        categoryData.push({
            {
                count
            }
        }); { % endfor %
        }

        new Chart(ctxCategory, {
            type: 'pie',
            data: {
                labels: categoryLabels,
                datasets: [{
                    data: categoryData,
                    backgroundColor: categoryColors,
                    borderWidth: 1,
                    hoverOffset: 20
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'right',
                        labels: {
                            boxWidth: 20,
                            font: {
                                size: 12
                            }
                        }
                    },
                    tooltip: {
                        callbacks: {
                            label: context => `${context.label}: ${context.raw} products`
                        }
                    }
                },
                animation: {
                    duration: 1200,
                    easing: 'easeOutQuart'
                }
            }
        });

        // Subscription Chart
        const ctxSubscription = document.getElementById('subscription-chart').getContext('2d');
        const subscriptionLabels = [];
        const subscriptionData = [];

        { %
            for date, amount in subscription_data.items %
        }
        subscriptionLabels.push('{{ date }}');
        subscriptionData.push({
            {
                amount | floatformat: 2
            }
        }); { % endfor %
        }

        new Chart(ctxSubscription, {
            type: 'bar',
            data: {
                labels: subscriptionLabels,
                datasets: [{
                    label: 'Subscription Revenue (ZMW)',
                    data: subscriptionData,
                    backgroundColor: 'rgba(255, 159, 64, 0.5)',
                    borderColor: 'rgba(255, 159, 64, 1)',
                    borderWidth: 1,
                    hoverBackgroundColor: 'rgba(255, 159, 64, 0.7)'
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    tooltip: {
                        callbacks: {
                            label: context => `Revenue: ZMW ${context.raw}`
                        }
                    },
                    legend: {
                        position: 'top',
                        labels: {
                            font: {
                                size: 12
                            }
                        }
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        title: {
                            display: true,
                            text: 'Revenue (ZMW)',
                            font: {
                                size: 14
                            }
                        },
                        grid: {
                            color: 'rgba(0, 0, 0, 0.05)'
                        }
                    },
                    x: {
                        title: {
                            display: true,
                            text: 'Date',
                            font: {
                                size: 14
                            }
                        },
                        grid: {
                            color: 'rgba(0, 0, 0, 0.05)'
                        }
                    }
                },
                animation: {
                    duration: 1200,
                    easing: 'easeOutQuart'
                }
            }
        });

        // User Management
        const toggleButtons = document.querySelectorAll('.toggle-user');
        const roleLinks = document.querySelectorAll('.change-role');
        const deleteButtons = document.querySelectorAll('.delete-user');
        const confirmDeleteButton = document.getElementById('confirm-delete-user');
        let userIdToDelete = null;

        toggleButtons.forEach(button => {
            button.addEventListener('click', () => {
                const userId = button.getAttribute('data-user-id');
                const isActive = button.getAttribute('data-active') === 'true';
                fetch('{% url "reports:toggle_user_active" 0 %}'.replace('0', userId), {
                        method: 'POST',
                        headers: {
                            'X-CSRFToken': '{{ csrf_token }}',
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            active: !isActive
                        })
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            window.location.reload();
                        } else {
                            alert('Error: ' + data.error);
                        }
                    });
            });
        });

        roleLinks.forEach(link => {
            link.addEventListener('click', (e) => {
                e.preventDefault();
                const userId = link.getAttribute('data-user-id');
                const role = link.getAttribute('data-role');
                fetch('{% url "reports:change_user_role" 0 %}'.replace('0', userId), {
                        method: 'POST',
                        headers: {
                            'X-CSRFToken': '{{ csrf_token }}',
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            role: role
                        })
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            window.location.reload();
                        } else {
                            alert('Error: ' + data.error);
                        }
                    });
            });
        });

        deleteButtons.forEach(button => {
            button.addEventListener('click', () => {
                userIdToDelete = button.getAttribute('data-user-id');
            });
        });

        confirmDeleteButton.addEventListener('click', () => {
            if (userIdToDelete) {
                fetch('{% url "reports:delete_user" 0 %}'.replace('0', userIdToDelete), {
                        method: 'POST',
                        headers: {
                            'X-CSRFToken': '{{ csrf_token }}',
                            'Content-Type': 'application/json'
                        }
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            window.location.reload();
                        } else {
                            alert('Error: ' + data.error);
                        }
                    });
            }
        });
    });
</script>

<style>
    /* CSS Variables */
    
     :root {
        --primary-color: #007bff;
        --primary-hover: #0056b3;
        --shadow-light: 0 4px 12px rgba(0, 0, 0, 0.08);
        --shadow-hover: 0 6px 16px rgba(0, 0, 0, 0.12);
        --transition: all 0.3s ease;
        --border-radius: 12px;
    }
    /* Gradient Header */
    
    .bg-gradient-primary {
        background: linear-gradient(135deg, var(--primary-color) 0%, #00aaff 100%);
    }
    /* General Card Styles */
    
    .card {
        border-radius: var(--border-radius);
        transition: var(--transition);
    }
    
    .card-header {
        border-top-left-radius: var(--border-radius);
        border-top-right-radius: var(--border-radius);
    }
    
    .card:hover {
        box-shadow: var(--shadow-hover);
    }
    /* Admin Card Styles */
    
    .admin-card {
        transition: var(--transition);
    }
    
    .admin-card:hover {
        transform: translateY(-5px);
        background-color: #f8f9fa;
    }
    
    .admin-card .card-title {
        transition: var(--transition);
    }
    
    .admin-card:hover .card-title {
        color: var(--primary-color);
    }
    /* Button Styles */
    
    .btn-hover {
        transition: var(--transition);
    }
    
    .btn-hover:hover {
        transform: translateY(-3px);
        box-shadow: var(--shadow-light);
    }
    
    .btn-primary.btn-hover:hover {
        background-color: var(--primary-hover);
        border-color: var(--primary-hover);
    }
    
    .btn-outline-primary.btn-hover:hover,
    .btn-light.btn-hover:hover {
        background-color: var(--primary-color);
        color: #fff;
        border-color: var(--primary-color);
    }
    
    .btn-outline-danger.btn-hover:hover {
        background-color: #dc3545;
        color: #fff;
        border-color: #dc3545;
    }
    /* Table Styles */
    
    .table-hover tbody tr:hover {
        background-color: rgba(0, 123, 255, 0.05);
        12px;
        cursor: pointer;
    }
    
    th[data-sort] {
        user-select: none;
    }
    
    th[data-sort] .fa-sort {
        opacity: 0.5;
    }
    
    th[data-sort] .fa-sort-up,
    th[data-sort] .fa-sort-down {
        opacity: 1;
    }
    /* Form Styles */
    
    .form-control {
        border-radius: 8px;
    }
    
    .form-control:focus {
        border-color: var(--primary-color);
        box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);
    }
    
    .invalid-feedback {
        display: none;
    }
    
    .form-control:invalid~.invalid-feedback {
        display: block;
    }
    /* Modal Styles */
    
    .modal-content {
        border-radius: var(--border-radius);
    }
    /* Dark Mode */
    
    body.bg-dark .card {
        background-color: #343a40;
        color: #f8f9fa;
    }
    
    body.bg-dark .card-header {
        background: linear-gradient(135deg, #495057 0%, #6c757d 100%);
    }
    
    body.bg-dark .table {
        color: #f8f9fa;
    }
    
    body.bg-dark .table-hover tbody tr:hover {
        background-color: rgba(255, 255, 255, 0.1);
    }
    
    body.bg-dark .table-light {
        background-color: #495057;
    }
    
    body.bg-dark .bg-primary.bg-opacity-10 {
        background-color: #495057 !important;
    }
    
    body.bg-dark .text-muted {
        color: #adb5bd !important;
    }
    
    body.bg-dark .badge.bg-success {
        background-color: #28a745 !important;
    }
    
    body.bg-dark .badge.bg-warning {
        background-color: #ffc107 !important;
    }
    
    body.bg-dark .badge.bg-info {
        background-color: #17a2b8 !important;
    }
    
    body.bg-dark .badge.bg-danger {
        background-color: #dc3545 !important;
    }
    /* Responsive Adjustments */
    
    @media (max-width: 767px) {
        .admin-card .h3 {
            font-size: 1.5rem;
        }
        .card-body {
            padding: 1rem;
        }
        .table {
            font-size: 0.85rem;
        }
        .btn-sm {
            padding: 0.25rem 0.5rem;
            font-size: 0.8rem;
        }
    }
    
    @media (max-width: 576px) {
        .fs-2 {
            font-size: 1.75rem;
        }
        .table-responsive {
            font-size: 0.8rem;
        }
    }
</style>
{% endblock %}